postprocessor_pipeline: # set by postprocessor_pipeline_name

  # Fill holes in the map with inpainting.
   - name: inpaint
     type: gridMapCv/InpaintFilter
     params:
       input_layer: elevation
       output_layer: elevation_inpainted
       radius: 0.1 #0.05

  # Compute Surface normals
   - name: surface_normals
     type: gridMapFilters/NormalVectorsFilter
     params:
       input_layer: elevation_inpainted
       output_layers_prefix: normal_vectors_
       radius: 0.15 #0.05  radius must be > map resolution/2
       normal_vector_positive_axis: z

  # Compute the slope based of the surface normals.
   - name: slope_calc
     type: gridMapFilters/MathExpressionFilter
     params:
       output_layer: slope
       expression: acos(normal_vectors_z)

  # Duplicate slope layer.
   - name: duplicate_slope
     type: gridMapFilters/DuplicationFilter
     params:
       input_layer: slope
       output_layer: edges

  # Duplicate slope layer.
   - name: duplicate_slope2
     type: gridMapFilters/DuplicationFilter
     params:
       input_layer: slope
       output_layer: limit_slope

  # Set lower threshold of slope, keeps only steep slopes
   - name: steep_slope_thresholded1
     type: gridMapFilters/ThresholdFilter
     params:
       condition_layer: slope
       output_layer: edges
       lower_threshold: 1.0 #  !!! CUSTOM VALUE !!! slopes above this angle [rad] are considered edges
       set_to: .nan

  # Set upper threshold of slope, keeps only steep slopes
   - name: steep_slope_thresholded2
     type: gridMapFilters/ThresholdFilter
     params:
       condition_layer: slope
       output_layer: edges
       upper_threshold: 1.0 #  !!! CUSTOM VALUE !!! slopes above this angle [rad] are considered edges
       set_to: 1.0


  ### apply limits to data
  # get limit by thresholding slope. Set untraversible parts to 1. 
   - name: limit_slope
     type: gridMapFilters/ThresholdFilter
     params:
       condition_layer: slope
       output_layer: limit_slope
       upper_threshold: 0.500108991839 #  !!! CUSTOM VALUE !!! slopes above this angle [rad] are considered untraversible
       set_to: 1.0

  # get height in local region fpr egdes
   - name: edge_height
     type: gridMapFilters/SlidingWindowMathExpressionFilter
     params:
       input_layer: elevation
       output_layer: local_height_diff
       expression: max(elevation) - min(elevation) # get height of edge as max height difference in region around edge
       # expression: meanOfFinites(elevation) # Box blur
       # expression: sqrt(sumOfFinites(square(input - meanOfFinites(input))) ./ numberOfFinites(input)) # Standard deviation
       # expression: 'sumOfFinites([0,-1,0;-1,5,-1;0,-1,0].*elevation_inpainted)' # Sharpen with kernel matrix
       compute_empty_cells: false
       edge_handling: crop # options: inside, crop, empty, mean
       window_size: 5 # in number of cells (optional, default: 3), make sure to make this compatible with the kernel matrix
       # window_length: 0.05 # instead of window_size, in m

  # Duplicate slope layer.
   - name: duplicate_local_height_diff
     type: gridMapFilters/DuplicationFilter
     params:
       input_layer: local_height_diff
       output_layer: big_local_height_diff

  # Set lower threshold of edge heights, keeps only heigh edges
   - name: edge_height_threshold
     type: gridMapFilters/ThresholdFilter
     params:
       condition_layer: local_height_diff
       output_layer: big_local_height_diff
       lower_threshold: 0.5 # !!! CUSTOM VALUE !!! edges below this height can be traversed
       set_to: .nan

  # height only necessary at edges
   - name: edge_calc
     type: gridMapFilters/MathExpressionFilter
     params:
       output_layer: limit_edge
       expression: big_local_height_diff .* edges


  # merge limits
   - name: merge_limits
     type: gridMapFilters/MathExpressionFilter
     params:
       output_layer: limits_merged
       expression: limit_slope .* limit_edge

  # minimum limit
  # - name: min_limit
  #   type: gridMapFilters/ThresholdFilter
  #   params:
  #     condition_layer: limits_merged
  #     output_layer: limits_merged
  #     upper_threshold: 1.0 # 
  #     set_to: 1.0
